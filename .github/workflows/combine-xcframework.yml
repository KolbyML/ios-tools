name: Combine XCFramework

on:
  workflow_dispatch:

jobs:
  # Trigger all 3 builds in parallel
  build-openjdk:
    uses: ./.github/workflows/build-openjdk.yml

  build-openjdk-sim:
    uses: ./.github/workflows/build-openjdk-sim.yml
    
  build-host-jdk:
    uses: ./.github/workflows/build-host-jdk.yml

  combine:
    needs: [ build-openjdk, build-openjdk-sim, build-host-jdk ]
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- DOWNLOAD ARTIFACTS ---
      
      - name: Download Host JDK
        uses: actions/download-artifact@v4
        with:
          name: host-jdk
          path: ./host-jdk

      - name: Download Device JMODs
        uses: actions/download-artifact@v4
        with:
          name: jmods.device
          path: ./jmods.device

      - name: Download Device Static Libs
        uses: actions/download-artifact@v4
        with:
          name: libjvm-device
          path: ./device

      - name: Download Simulator Static Libs
        uses: actions/download-artifact@v4
        with:
          name: libjvm-simulator
          path: ./simulator
          
      # --- PREPARE SUPPORT FILES ---
      - name: Download and unzip mobile-support
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download libffi-build -p "libffi-ios.zip" -p "libffi-ios-sim.zip"
          unzip libffi-ios.zip -d libffi-ios
          unzip libffi-ios-sim.zip -d libffi-ios-sim

      # --- BUILD XCFRAMEWORK ---
      - name: Create XCFramework
        run: |
          chmod +x .github/scripts/build-xcframework.sh
          .github/scripts/build-xcframework.sh

      # --- GENERATE JRE BUNDLE ---
      - name: Create JRE Bundle using Host JDK
        run: |
          echo "Generating JRE bundle..."
          
          # Make our custom jlink executable
          chmod +x ./host-jdk/bin/jlink
          
          # Use Host jlink + Device JMODs
          ./host-jdk/bin/jlink \
            --module-path ./jmods.device \
            --add-modules java.base,java.compiler,java.datatransfer,java.desktop,java.instrument,java.logging,java.management,java.naming,java.prefs,java.scripting,java.se,java.security.jgss,java.security.sasl,java.sql,java.transaction.xa,java.xml,jdk.attach,jdk.crypto.ec,jdk.jdi,jdk.management,jdk.net,jdk.unsupported,jdk.unsupported.desktop,jdk.zipfs,jdk.accessibility,jdk.charsets,jdk.localedata \
            --bind-services \
            --output jre_bundle \
            --strip-debug \
            --no-man-pages \
            --no-header-files \
            --compress=2
            
          echo "Zipping JRE bundle..."
          zip -r jre_bundle.zip jre_bundle

      # --- PACK AND UPLOAD ---
      - name: Compress Artifacts
        run: |
          zip -r OpenJDK.xcframework.zip OpenJDK.xcframework
          
          # Optional: Zip JMODs for debugging
          cd jmods.device && zip -r ../jmods.device.zip . && cd ..

      - name: Create snapshot release
        uses: softprops/action-gh-release@v2
        with:
          name: "Snapshot release"
          tag_name: snapshot
          prerelease: true
          files: |
            OpenJDK.xcframework.zip
            jmods.device.zip
            jre_bundle.zip