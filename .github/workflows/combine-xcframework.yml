name: Combine XCFramework

on:
  workflow_dispatch:

jobs:
  # 1. Trigger parallel builds
  build-openjdk:
    uses: ./.github/workflows/build-openjdk.yml

  build-openjdk-sim:
    uses: ./.github/workflows/build-openjdk-sim.yml
    
  build-host-jdk:
    uses: ./.github/workflows/build-host-jdk.yml

  # 2. Combine them
  combine:
    needs: [ build-openjdk, build-openjdk-sim, build-host-jdk ]
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- DOWNLOAD ARTIFACTS ---
      
      - name: Download Host JDK
        uses: actions/download-artifact@v4
        with:
          name: host-jdk
          path: ./host-jdk

      - name: Download Device Java (Exploded Classes)
        uses: actions/download-artifact@v4
        with:
          name: java.device
          path: ./java.device

      - name: Download Device Static Libs
        uses: actions/download-artifact@v4
        with:
          name: libjvm-device
          path: ./device

      - name: Download Simulator Static Libs
        uses: actions/download-artifact@v4
        with:
          name: libjvm-simulator
          path: ./simulator
          
      - name: Download and unzip mobile-support
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download libffi-build -p "libffi-ios.zip" -p "libffi-ios-sim.zip"
          unzip libffi-ios.zip -d libffi-ios
          unzip libffi-ios-sim.zip -d libffi-ios-sim

      # --- PACKAGE JMODS ---
      - name: Create Compatible JMODs
        run: |
          mkdir -p jmods-temp
          chmod +x ./host-jdk/bin/jmod
          
          echo "Packaging exploded modules into JMODs..."
          
          # Iterate over each module folder
          for mod_dir in ./java.device/*; do
            if [ -d "$mod_dir" ]; then
              mod_name=$(basename "$mod_dir")
              echo "  - Packaging $mod_name..."
              
              # Use the Host 'jmod' tool
              ./host-jdk/bin/jmod create \
                --class-path "$mod_dir" \
                --target-platform ios-aarch64 \
                "jmods-temp/$mod_name.jmod"
            fi
          done

      # --- GENERATE JRE BUNDLE ---
      - name: Create JRE Bundle using Host JDK
        run: |
          echo "Generating JRE bundle..."
          chmod +x ./host-jdk/bin/jlink
          
          # FIX 1: Removed --strip-debug (Likely corruption source)
          # FIX 2: Forced --compress=0 (No compression)
          ./host-jdk/bin/jlink \
            --module-path ./jmods-temp \
            --add-modules java.base,java.compiler,java.datatransfer,java.desktop,java.instrument,java.logging,java.management,java.naming,java.prefs,java.scripting,java.se,java.security.jgss,java.security.sasl,java.sql,java.transaction.xa,java.xml,jdk.attach,jdk.crypto.ec,jdk.jdi,jdk.management,jdk.net,jdk.unsupported,jdk.unsupported.desktop,jdk.zipfs,jdk.accessibility,jdk.charsets,jdk.localedata \
            --bind-services \
            --output jre_bundle \
            --no-man-pages \
            --no-header-files \
            --compress=0
            
          echo "Verifying generated modules file..."
          if [ -f "jre_bundle/lib/modules" ]; then
             echo "modules file exists. Size:"
             ls -lh jre_bundle/lib/modules
             
             # Optional: Run verification on the runner itself
             ./host-jdk/bin/jimage verify jre_bundle/lib/modules
          else
             echo "ERROR: modules file was not generated!"
             exit 1
          fi

          echo "Zipping JRE bundle..."
          zip -r jre_bundle.zip jre_bundle

      # --- BUILD XCFRAMEWORK ---
      - name: Create XCFramework
        run: |
          chmod +x .github/scripts/build-xcframework.sh
          .github/scripts/build-xcframework.sh

      # --- PACK AND UPLOAD ---
      - name: Compress Artifacts
        run: |
          zip -r OpenJDK.xcframework.zip OpenJDK.xcframework
          cd java.device && zip -r ../java.device.zip . && cd ..

      - name: Create snapshot release
        uses: softprops/action-gh-release@v2
        with:
          name: "Snapshot release"
          tag_name: snapshot
          prerelease: true
          files: |
            OpenJDK.xcframework.zip
            java.device.zip
            jre_bundle.zip