name: Build OpenJDK Mobile

on:
  workflow_call:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: 'Install toolchain and dependencies'
        run: |
          brew install libffi
          brew install autoconf make
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
          echo '/usr/local/opt/make/libexec/gnubin' >> $GITHUB_PATH

      - name: Checkout builder repo
        uses: actions/checkout@v3

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Download and unzip mobile-support
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download libffi-build --pattern "libffi-ios.zip"
          mkdir -p ../support
          unzip libffi-ios.zip -d ../support

      - name: Clone OpenJDK Mobile sources
        run: |
          git clone https://github.com/kolbyml/mobile.git
          cp openjdk-ext/src/hotspot/symbol_keeper.cpp mobile/src/hotspot/os/bsd
          cd mobile
          git checkout master
          
          # 1. Configure
          bash configure \
          --with-conf-name=ios-aarch64-zero-release \
          --disable-warnings-as-errors \
          --openjdk-target=aarch64-macos-ios \
          --with-sysroot=/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk \
          --with-libffi-include=$(realpath ../../support/include/ffi) \
          --with-libffi-lib=$(realpath ../../support) \
          --with-cups-include=$(xcrun --sdk macosx --show-sdk-path)/usr/include

      # --- PATCH STEP: APPEND MODULES ---
      - name: Patch Static Libs Makefile
        run: |
          cd mobile
          
          # 1. Find the file. It is almost certainly make/StaticLibs.gmk
          # If not found there, we look for any file defining STATIC_LIBS_MODULES
          TARGET_FILE=$(grep -l "STATIC_LIBS_MODULES" make/*.gmk 2>/dev/null || echo "make/StaticLibs.gmk")
          
          echo "Patching $TARGET_FILE with extra modules..."
          
          # 2. Append the modules using +=. This forces them to be added to the list.
          # We include the full list just to be safe.
          echo "" >> "$TARGET_FILE"
          echo "STATIC_LIBS_MODULES += java.compiler java.datatransfer java.desktop java.instrument java.logging java.management java.naming java.prefs java.scripting java.se java.security.jgss java.security.sasl java.sql java.transaction.xa java.xml jdk.attach jdk.crypto.ec jdk.jdi jdk.management jdk.net jdk.unsupported jdk.unsupported.desktop jdk.zipfs jdk.accessibility jdk.charsets jdk.localedata" >> "$TARGET_FILE"
          
          # 3. Print the last few lines to verify the patch in the logs
          tail -n 5 "$TARGET_FILE"

      - name: Build Static Image
        run: |
          cd mobile
          make LOG=cmdlines,info CONF=ios-aarch64-zero-release static-libs-image

      - name: Upload device artifact
        uses: actions/upload-artifact@v4
        with:
          name: libjvm-device
          path: |
            mobile/build/ios-aarch64-zero-release/images/static-libs/lib
            mobile/build/ios-aarch64-zero-release/jdk/conf
            mobile/build/ios-aarch64-zero-release/jdk/include

      - name: Upload java
        uses: actions/upload-artifact@v4
        with:
          name: java.device
          path: |
            mobile/build/ios-aarch64-zero-release/jdk/modules